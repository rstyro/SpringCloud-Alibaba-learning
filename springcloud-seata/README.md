### 一、前言
+ 事务指的就是一个操作单元，在这个操作单元中的所有操作最终要保持一致的行为，要么所有操作
都成功，要么所有的操作都被撤销。简单地说，事务提供一种 “要么什么都不做，要么做全套” 的机制。

#### 1、本地事务
+ 本地事务其实可以认为是数据库提供的事务机制。
+ 说到数据库事务就不得不说，数据库事务中的**四大特性:ACID**
	+ **A：原子性(Atomicity)**，一个事务中的所有操作，要么全部完成，要么全部不完成
	+ **C：一致性(Consistency)**，在一个事务执行之前和执行之后数据库都必须处于一致性状态
	+ **I：隔离性(Isolation)**，在并发环境中，当不同的事务同时操作相同的数据时，事务之间互不影响
	+ **D：持久性(Durability)**，指的是只要事务成功结束，它对数据库所做的更新就必须永久的保存下来
+ 数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，
+ 该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚

#### 2、分布式事务
+ 分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。
+ 简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，
+ 分布式事务需要保证这些小操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。

#### 3、分布式理论
+ 分布式系统的经典理论：CAP理论 与BASE理论

##### ①、CAP理论
+ CAP 定理（CAP theorem）又被称作布鲁尔定理（Brewer's theorem）。
+ 是加州大学伯克利分校的计算机科学家埃里克·布鲁尔（Eric Brewer）在2000年的`ACM PODC`上提出的一个猜想。
+ 2002年，麻省理工学院的赛斯·吉尔伯特（Seth Gilbert）和南希·林奇（Nancy Lynch）发表了布鲁尔猜想的证明，使之成为分布式计算领域公认的一个定理。
+ 是 `Consistency`、`Availablity`和`Partition-tolerance`的缩写。
	+ ***一致性（Consistency）：*** 即更新操作成功并返回客户端完成后， 所有节点在同一时间的数据完全一致，这里的一致性是指的强一致性，一般关系型数据库就有强一致性特性。。
	+ ***可用性（Availablity）：*** 即服务一直可用，而且是正常响应时间。
	+ ***分区容忍性（Partition-torlerance）：*** 在网络分区的情况下，被分隔的节点仍能正常对外服务


***CAP权衡：***

|选择|说明|
|--|--|
|CA|放弃分区容错性，加强一致性和可用性，其实就是传统的单机数据库的选择。放弃P的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的。|
|AP|放弃一致性（这里说的一致性是强一致性），追求分区容错性和可用性，这是很多分布式系统设计时的选择，例如很多NoSQL系统就是如此|
|CP|放弃可用性，追求一致性和分区容错性，基本不会选择，网络问题会直接让整个系统不可用|

***总结：***
+ CAP理论，我们知道无法同时满足一致性、可用性和分区容错性这三个特性。
+ CAP理论告诉我们分布式系统只能选择`CP`或者`AP`,因为放弃P那就不是分布式系统了，所以一般都会根据业务在C和A之间寻求平衡。。

##### ②、BASE理论
+ eBay的架构师`Dan Pritchett`源于对大规模分布式系统的实践总结，在ACM上发表文章提出`BASE理论`，BASE理论是对CAP理论的延伸。
+ BASE是指基本可用（Basically Available）、软状态（Soft State）、最终一致性（ Eventual Consistency）
+ 核心思想是即使无法做到强一致性，但应用可以采用适合的方式达到最终一致性（Eventual Consitency）
+ 每一个应用都可以根据自身的业务特点，采用适当的方式达到最终一致性。

***基本可用(Basically Available)***
+ 基本可用指分布式系统在出现不可预知的故障时候，允许损失部分可用性，保证核心服务可用。
+ 比如电商大促时，为了应对访问量激增，部分用户可能会被引导到降级页面，服务熔断限流

***软状态（Soft State）***
+ 简单的说就是不同节点的数据副本之间进行数据同步的过程存在延时，这个延时不影响可用性。
+ 例如一次写操作只更新了一个结点就返回成功。那么其他节点和这个节点的数据时不一致的。
+ 此时的数据状态就是软状态。

***最终一致性（ Eventual Consistency）***
+ 指最终数据要实现一致性，例如：软状态的数据最终我们要通过一些手段将数据同步到其他数据节点上。
+ 弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。

**BASE与ACID**
+ 总的来说，BASE理论面向的是大型高可用可扩展的分布式系统，和传统的事物ACID特性是相反的，
+ 它完全不同于ACID的强一致性模型，而是通过牺牲强一致性 来获得可用性。
+ 并允许数据在一段时间内是不一致的，但最终达到一致状态。
+ 但同时，在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的。
+ 因此在具体的分布式系统架构设计过程中，ACID特性和BASE理论往往又会结合在一起。

#### 4、一致性协议
+ 在分布式系统中，每一个机器节点虽然都能够明确的直到自己在进行事务操作中的结果时成功或失败，但却无法直接获取其他分布式节点的操作结果。
+ 因此，当一个事务操作需要跨越多个分布式节点的时候，为了保持事务处理的ACID特性。
+ 就需要引入一个称为`协调者(Coordinator)`的组件来统一调度所有分布式节点的执行逻辑,这些分布式节点则被称为`参与者(Participant)`.

##### 2PC
+ `Two Phase Commit`,顾名思义，二阶段提交的意思。
+ 第一阶段，准备阶段(投票阶段) ； 第二阶段，提交阶段（执行阶段）。


### 二、Seata 是什么?
+ Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。
+ Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。
+ 本文只介绍简单的使用，不讲原理

#### 1、Seata术语
+ **TC (Transaction Coordinator) - 事务协调者**
维护全局和分支事务的状态，驱动全局事务提交或回滚。
相当于 `seata-server`
+ **TM (Transaction Manager) - 事务管理器**
定义全局事务的范围：开始全局事务、提交或回滚全局事务。
相当于我们开启全局事务的发起方 `@GlobalTransactional`
+ **RM (Resource Manager) - 资源管理器**
管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
相当于我们的本地事务，：`@Transactional`

### 三、